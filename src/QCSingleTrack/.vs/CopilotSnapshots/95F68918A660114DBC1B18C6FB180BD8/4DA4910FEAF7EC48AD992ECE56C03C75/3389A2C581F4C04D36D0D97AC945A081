using System;
using System.Threading.Tasks;
using Microsoft.Azure.Functions.Worker;
using Microsoft.Extensions.Logging;
using QCSingleTrack.TrailStatusScraperFn.Services;
using QCSingleTrack.Infrastructure.Data;
using Microsoft.EntityFrameworkCore;

namespace QCSingleTrack.TrailStatusScraperFn;

public class TimerScrapeFunction
{
    private readonly ILogger _logger;
    private readonly ITrailScraper _scraper;
    private readonly IDbContextFactory<TrailStatusDbContext> _dbFactory;

    public TimerScrapeFunction(ILoggerFactory loggerFactory, ITrailScraper scraper, IDbContextFactory<TrailStatusDbContext> dbFactory)
    {
        _logger = loggerFactory.CreateLogger<TimerScrapeFunction>();
        _scraper = scraper;
        _dbFactory = dbFactory;
    }

    [Function("TimerScrapeFunction")]
    public async Task Run([TimerTrigger("0 */10 * * * *")] TimerInfo myTimer)
    {
        _logger.LogInformation("C# Timer trigger function executed at: {executionTime}", DateTime.UtcNow);
        if (myTimer.ScheduleStatus is not null)
        {
            _logger.LogInformation("Next timer schedule at: {nextSchedule}", myTimer.ScheduleStatus.Next);
        }

        var results = await _scraper.ScrapeForcAsync();
        _logger.LogInformation("Scraper returned {Count} results", System.Linq.Enumerable.Count(results));

        // Persist results to the database (simple upsert by TrailName)
        try
        {
            await using var db = _dbFactory.CreateDbContext();

            foreach (var r in results)
            {
                // find existing
                var existing = await db.TrailStatuses.FirstOrDefaultAsync(t => t.TrailName == r.TrailName);
                if (existing is null)
                {
                    db.TrailStatuses.Add(new QCSingleTrack.Domain.TrailStatus
                    {
                        TrailName = r.TrailName ?? string.Empty,
                        Status = r.Status ?? string.Empty,
                        LastScrapedTime = DateTime.UtcNow
                    });
                }
                else
                {
                    existing.Status = r.Status ?? existing.Status;
                    existing.LastScrapedTime = DateTime.UtcNow;
                }
            }

            await db.SaveChangesAsync();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error saving scraped results to database");
        }
    }
}