using Microsoft.EntityFrameworkCore;
using QCSingleTrack.Domain;
using QCSingleTrack.Infrastructure.Data;
using System.Net.NetworkInformation;

namespace QCSingleTrack.Application.Services;

public class TrailService : ITrailService
{
    private readonly IDbContextFactory<TrailStatusDbContext> _dbFactory;

    public TrailService(IDbContextFactory<TrailStatusDbContext> dbFactory)
    {
        _dbFactory = dbFactory;
    }

    public async Task<Trail?> GetTrailByIdAsync(int id)
    {
        await using var db = _dbFactory.CreateDbContext();
        return await db.Trails.FirstOrDefaultAsync(t => t.TrailId == id);
    }

    public async Task UpdateTrailStatusesAsync(IEnumerable<ScrapedTrailResult> results)
    {
        if (results == null) return;

        await using var db = _dbFactory.CreateDbContext();

        // Normalize and collect names from the results
        var names = results
            .Select(r => r.TrailName?.Trim())
            .Where(n => !string.IsNullOrWhiteSpace(n))
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .ToList();

        // Load existing trails that match any of the scraped names
        var existingTrails = await db.Trails
            .Where(t => names.Contains(t.TrailName!))
            .ToListAsync();

        var comparer = StringComparer.OrdinalIgnoreCase;

        foreach (var result in results)
        {
            var name = result.TrailName?.Trim();

            if (string.IsNullOrWhiteSpace(name)) continue;

            // Try find an existing trail (case-insensitive)
            var trail = existingTrails.FirstOrDefault(t => comparer.Equals(t.TrailName, name));

            if (trail == null)
            {
                // Create a new trail and attach a TrailStatus entry
                trail = new Trail
                {
                    TrailName = name,
                    LastStatusScrapedTime = DateTime.UtcNow,
                    Status = result.Status
                };

                db.Trails.Add(trail);
                existingTrails.Add(trail);
            }
            else
            {
                trail.LastStatusScrapedTime = DateTime.UtcNow;
                trail.Status = result.Status;

                db.Trails.Update(trail);
            }
        }

        await db.SaveChangesAsync();
    }
}
